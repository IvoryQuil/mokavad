<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Menú con Categorías y Pedido</title>
<style>
  body {
    background-color: #121212;
    color: #ddd;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }
  .row {
    display: flex;
    flex-wrap: wrap;
    max-width: 960px;
    margin: auto;
    padding: 0 1rem;
  }
  .col-four {
    flex: 0 0 33.3333%;
    padding: 1rem;
  }
  .col-eight {
    flex: 0 0 66.6666%;
    padding: 1rem;
  }
  h3 {
    margin-top: 0;
  }
  ul {
    list-style: none;
    padding-left: 0;
  }
  ul li {
    margin-bottom: 0.8rem;
  }
  a {
    color: #dddddd;
    text-decoration: none;
    cursor: pointer;
  }
  a:hover {
    text-decoration: underline;
  }
  button {
    background-color: #444;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-radius: 4px;
  }
  button:hover {
    background-color: #555;
  }
  .cantidad-control {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.3rem;
  }
  .cantidad-control button {
    background-color: #444;
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    font-size: 18px;
    cursor: pointer;
    border-radius: 4px;
  }
  .cantidad-control span {
    min-width: 24px;
    text-align: center;
  }
  #mensaje {
    margin-top: 1rem;
  }
  #resumen-pedido ul {
    margin-top: 0.5rem;
  }
  /* Responsive */
  @media (max-width: 700px) {
    .col-four, .col-eight {
      flex: 0 0 100%;
    }
  }
</style>
</head>
<body>

<!-- Sección de Categorías -->
<section id="categorias" style="padding: 4rem 0; background-color: #1a1a1a;">
   <div class="row">
      <!-- Menú de Categorías -->
      <div class="col-four">
         <h3 style="color: #ffffff;">Categorías</h3>
         <ul id="categoria-menu" style="list-style: none; padding-left: 0; line-height: 2;">
            <li><a href="#" onclick="mostrarCategoria('bebestibles')">Bebestibles</a></li>
            <li><a href="#" onclick="mostrarCategoria('desayunos_y_onces')">Desayunos y Onces</a></li>
            <li><a href="#" onclick="mostrarCategoria('menu_almuerzo')">Menú Almuerzo</a></li>
            <li><a href="#" onclick="mostrarCategoria('pasteleria')">Pastelería</a></li>
            <li><a href="#" onclick="mostrarCategoria('pizzas')">Pizzas</a></li>
            <li><a href="#" onclick="mostrarCategoria('sandwich')">Sándwich</a></li>
         </ul>
      </div>

      <!-- Contenido de la Categoría -->
      <div class="col-eight">
         <h3 id="titulo-categoria" style="color: #ffffff;">Selecciona una categoría</h3>
         <form id="form-pedido" style="color: #dddddd; padding-top: 1rem;">
            <div id="contenido-categoria"></div>
            <button type="button" onclick="mostrarResumen()" style="margin-top: 1rem; padding: 0.5rem 1rem;">Ver Resumen</button>
            <div id="resumen-pedido" style="margin-top: 1rem; display: none;"></div>
            <button type="submit" id="confirmar-btn" style="margin-top: 1rem; display: none; padding: 0.5rem 1rem;">Confirmar Pedido</button>
         </form>
         <div id="mensaje" style="margin-top: 1rem; color: #aaffaa;"></div>
      </div>
   </div>
</section>

<script>
   let productosPedidos = {};
   let productosActuales = {};

   function cambiarCantidad(id, cambio) {
      const cantidadActual = (productosPedidos[id] || 0) + cambio;
      productosPedidos[id] = Math.max(cantidadActual, 0);
      const span = document.getElementById(`cantidad-${id}`);
      if (span) span.textContent = productosPedidos[id];
      const input = document.getElementById(`input-${id}`);
      if (input) input.value = productosPedidos[id];
   }

   function esProducto(obj) {
      return obj && typeof obj === 'object' && 'nombre' in obj && 'precio' in obj;
   }

   async function mostrarCategoria(categoria) {
      const titulo = document.getElementById("titulo-categoria");
      const contenido = document.getElementById("contenido-categoria");
      const mensaje = document.getElementById("mensaje");
      const resumenDiv = document.getElementById("resumen-pedido");
      resumenDiv.style.display = "none";
      document.getElementById("confirmar-btn").style.display = "none";

      mensaje.textContent = "";
      const nombreFormateado = categoria.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      titulo.textContent = nombreFormateado;

      const url = `https://mokavad-8700c-default-rtdb.firebaseio.com/platos/${categoria}.json`;

      try {
         const response = await fetch(url);
         if (!response.ok) throw new Error("Error al cargar los datos");
         const data = await response.json();
         let html = "";

         if (!data || Object.keys(data).length === 0) {
            contenido.innerHTML = "<p>No hay productos disponibles en esta categoría.</p>";
            return;
         }

         productosActuales = { ...productosActuales }; // mantener existentes

         for (const key in data) {
            const valor = data[key];
            if (esProducto(valor)) {
               const id = `directo__${key}`;
               productosActuales[id] = valor;
            } else {
               for (const subkey in valor) {
                  const id = `${key}__${subkey}`;
                  productosActuales[id] = valor[subkey];
               }
            }
         }

         for (const key in data) {
            const valor = data[key];
            if (esProducto(valor)) {
               const id = `directo__${key}`;
               const cantidad = productosPedidos[id] || 0;
               html += `
                  <h4 style="margin-top: 1.5rem; color: #ffcc00;">Productos</h4>
                  <ul style='list-style:none; padding-left:0;'>
                     <li style="margin-bottom: 1rem;">
                        <strong>${valor.nombre}</strong><br>
                        <em>${valor.descripcion || ''}</em><br>
                        Precio: $${valor.precio.toLocaleString()}<br>
                        <div class="cantidad-control">
                           <button type="button" onclick="cambiarCantidad('${id}', -1)">-</button>
                           <span id="cantidad-${id}">${cantidad}</span>
                           <button type="button" onclick="cambiarCantidad('${id}', 1)">+</button>
                        </div>
                        <input type="hidden" name="${id}" id="input-${id}" value="${cantidad}">
                     </li>
                  </ul>`;
            } else {
               html += `<h4 style="margin-top: 1.5rem; color: #ffcc00;">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4><ul style='list-style:none; padding-left:0;'>`;
               for (const subkey in valor) {
                  const plato = valor[subkey];
                  const id = `${key}__${subkey}`;
                  const cantidad = productosPedidos[id] || 0;
                  html += `
                     <li style="margin-bottom: 1rem;">
                        <strong>${plato.nombre}</strong><br>
                        <em>${plato.descripcion || ''}</em><br>
                        Precio: $${plato.precio.toLocaleString()}<br>
                        <div class="cantidad-control">
                           <button type="button" onclick="cambiarCantidad('${id}', -1)">-</button>
                           <span id="cantidad-${id}">${cantidad}</span>
                           <button type="button" onclick="cambiarCantidad('${id}', 1)">+</button>
                        </div>
                        <input type="hidden" name="${id}" id="input-${id}" value="${cantidad}">
                     </li>`;
               }
               html += "</ul>";
            }
         }

         contenido.innerHTML = html;

      } catch (error) {
         contenido.innerHTML = `<p style="color: #ff5555;">Error cargando la categoría: ${error.message}</p>`;
      }
   }

   function mostrarResumen() {
      const resumenDiv = document.getElementById("resumen-pedido");
      resumenDiv.innerHTML = "";
      let total = 0;
      let contenido = "<strong>Resumen del pedido:</strong><ul style='margin-top: 0.5rem;'>";

      for (const id in productosPedidos) {
         const cantidad = productosPedidos[id];
         const producto = productosActuales[id];
         if (cantidad > 0 && producto) {
            const subtotal = cantidad * producto.precio;
            total += subtotal;
            contenido += `<li>${producto.nombre} - $${producto.precio.toLocaleString()} x ${cantidad} = $${subtotal.toLocaleString()}</li>`;
         }
      }

      if (total === 0) {
         resumenDiv.innerHTML = "<p style='color: #ff5555;'>No has seleccionado productos aún.</p>";
         return;
      }

      contenido += `</ul><strong>Total: $${total.toLocaleString()}</strong>`;
      resumenDiv.innerHTML = contenido;
      resumenDiv.style.display = "block";
      document.getElementById("confirmar-btn").style.display = "inline-block";
   }

   document.getElementById("form-pedido").addEventListener("submit", async (e) => {
      e.preventDefault();
      const mensaje = document.getElementById("mensaje");
      mensaje.textContent = "Enviando pedido...";
      mensaje.style.color = "#aaffaa";

      const pedido = {
         fecha: new Date().toISOString(),
         productos: {},
      };

      for (const id in productosPedidos) {
         const cantidad = productosPedidos[id];
         const producto = productosActuales[id];
         if (cantidad > 0 && producto) {
            pedido.productos[id] = {
               nombre: producto.nombre,
               cantidad: cantidad,
               precio_unitario: producto.precio,
               subtotal: cantidad * producto.precio,
            };
         }
      }

      pedido.total = Object.values(pedido.productos).reduce((acc, p) => acc + p.subtotal, 0);

      try {
         const response = await fetch("https://mokavad-8700c-default-rtdb.firebaseio.com/pedidos.json", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(pedido),
         });

         if (!response.ok) throw new Error("Error al enviar pedido");

         mensaje.innerHTML = `<strong>Pedido enviado con éxito</strong><br>Total: $${pedido.total.toLocaleString()}`;
         productosPedidos = {};
         document.getElementById("resumen-pedido").style.display = "none";
         document.getElementById("confirmar-btn").style.display = "none";
         document.querySelectorAll('[id^="cantidad-"]').forEach(el => el.textContent = "0");
         document.querySelectorAll('[id^="input-"]').forEach(el => el.value = "0");

      } catch (err) {
         mensaje.style.color = "#ff5555";
         mensaje.textContent = "Error al enviar pedido: " + err.message;
      }
   });
</script>

</body>
</html>
